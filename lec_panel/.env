# Flask Attendance System - Development Configuration
# Updated with Celery enabled for development

# ============================================================================
# APPLICATION
# ============================================================================
FLASK_APP=run.py
FLASK_ENV=development
FLASK_DEBUG=1
SECRET_KEY=your-secret-key-change-this-in-production

# Server Configuration (Fixed for Windows port reservation issues)
# Port 8080 avoids Hyper-V reserved port ranges (typically 5000-5100)
PORT=8080
HOST=127.0.0.1

# Alternative ports if 8080 is taken:
# PORT=10000
# PORT=3000

# ============================================================================
# DATABASE
# ============================================================================
DEV_DATABASE_URL=sqlite:///C:/Users/HP/.vscode/attendance system/attendance.db

# ============================================================================
# REDIS & CACHE CONFIGURATION
# ============================================================================
# Using 127.0.0.1 (confirmed working from test_redis.py)
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_URL=redis://127.0.0.1:6379/0

# Enable Redis caching (for performance)
ENABLE_CACHE=true
CACHE_TYPE=redis
CACHE_REDIS_URL=redis://127.0.0.1:6379/0
CACHE_KEY_PREFIX=attendance:

# Development cache timeouts (shorter for faster development)
CACHE_DEFAULT_TIMEOUT=60
CACHE_TTL_DASHBOARD=60          # 1 minute - Dashboard stats
CACHE_TTL_SESSION=300           # 5 minutes - Session data  
CACHE_TTL_STUDENT_LIST=300      # 5 minutes - Student lists
CACHE_TTL_FACE_ENCODING=1800    # 30 minutes - Face encodings
CACHE_TTL_STATS=60              # 1 minute - Statistics
CACHE_TTL_REPORT=300            # 5 minutes - Reports

# ============================================================================
# SESSION STORAGE (using Redis)
# ============================================================================
SESSION_TYPE=redis
SESSION_REDIS=redis://127.0.0.1:6379/0

# ============================================================================
# SECURITY
# ============================================================================
ENABLE_MFA=false
SESSION_COOKIE_SECURE=false
REMEMBER_COOKIE_SECURE=false

# ============================================================================
# FACE RECOGNITION
# ============================================================================
FACE_RECOGNITION_TOLERANCE=0.6
FACE_RECOGNITION_MODEL=hog

# ============================================================================
# EMAIL CONFIGURATION
# ============================================================================
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USERNAME=vikiwanguu@gmail.com
MAIL_PASSWORD=wegk qzgw bdes yxyi
MAIL_DEFAULT_SENDER=noreply@attendance.edu

# ============================================================================
# FILE STORAGE
# ============================================================================
UPLOAD_FOLDER=uploads
MAX_CONTENT_LENGTH=16777216

# ============================================================================
# CELERY (Background Tasks with Redis) - ENABLED FOR DEVELOPMENT
# ============================================================================
ENABLE_CELERY=true
CELERY_BROKER_URL=redis://127.0.0.1:6379/0
CELERY_RESULT_BACKEND=redis://127.0.0.1:6379/0

# Celery Configuration
CELERY_TASK_SERIALIZER=json
CELERY_RESULT_SERIALIZER=json
CELERY_ACCEPT_CONTENT=json
CELERY_TIMEZONE=Africa/Nairobi
CELERY_ENABLE_UTC=true
CELERY_TASK_TRACK_STARTED=true

# Task timeouts (in seconds)
CELERY_TASK_TIME_LIMIT=300          # 5 minutes hard limit
CELERY_TASK_SOFT_TIME_LIMIT=240     # 4 minutes soft limit

# Development settings - tasks run eagerly in tests
CELERY_TASK_ALWAYS_EAGER=false      # Set to true to run tasks synchronously (for debugging)
CELERY_TASK_EAGER_PROPAGATES=false  # Set to true for eager task error propagation

# ============================================================================
# WEBSOCKET (Real-time Features)
# ============================================================================
# Using threading mode (simple, perfect for development on Windows)
ENABLE_WEBSOCKET=true
SOCKETIO_ASYNC_MODE=threading

# NOTE: Do NOT set SOCKETIO_MESSAGE_QUEUE for threading mode
# Redis message queue is only for eventlet/gevent with multiple workers

# ============================================================================
# API
# ============================================================================
ENABLE_API=true
API_RATE_LIMIT=100 per hour

# ============================================================================
# LOGGING & PERFORMANCE MONITORING
# ============================================================================
LOG_LEVEL=DEBUG
LOG_FILE=logs/app.log
SLOW_QUERY_THRESHOLD=0.5
ENABLE_QUERY_LOGGING=true
ENABLE_PERFORMANCE_METRICS=true

# ============================================================================
# TIMEZONE
# ============================================================================
TIMEZONE=Africa/Nairobi

# ============================================================================
# WINDOWS + WSL2 + CELERY SETUP NOTES
# ============================================================================
# ✅ Redis running in WSL2 Ubuntu
# ✅ Port forwarding configured (Windows → WSL2)
# ✅ Redis accessible at 127.0.0.1:6379 (verified with test_redis.py)
# ✅ Using port 8080 to avoid Hyper-V port reservation
# ✅ Celery enabled for background task processing
#
# HOW TO RUN WITH CELERY:
# 
# Terminal 1 - Start Redis (in WSL2):
#   sudo service redis-server start
#   redis-cli ping  # Should return PONG
#
# Terminal 2 - Start Flask App:
#   python run.py
#
# Terminal 3 - Start Celery Worker (IMPORTANT - use 'solo' pool for Windows):
#   celery -A celery_worker.celery worker --loglevel=info --pool=solo
#
# Note: Windows requires --pool=solo because the default prefork pool doesn't work
#
# To verify Celery is working:
#   celery -A celery_worker.celery inspect active
#   celery -A celery_worker.celery inspect stats
#
# Port Forwarding Setup (Already Done):
#   netsh interface portproxy add v4tov4 listenport=6379 listenaddress=0.0.0.0 connectport=6379 connectaddress=172.26.145.83
#
# To verify Redis connection:
#   python -c "import redis; r = redis.Redis(host='127.0.0.1', port=6379); print(r.ping())"
#
# To verify port forwarding:
#   netsh interface portproxy show all
#
# If Port 8080 is Also Reserved:
# Run in PowerShell as Administrator:
#   net stop winnat
#   netsh int ipv4 add excludedportrange protocol=tcp startport=8080 numberofports=10 store=persistent
#   net start winnat
#
# Or try alternative ports: 10000, 3000, 9000
#
# TROUBLESHOOTING CELERY:
# - If you see "Connection refused" errors, make sure Redis is running
# - Use --pool=solo on Windows (not prefork, gevent, or eventlet)
# - Check Celery worker logs for task execution details
# - Set CELERY_TASK_ALWAYS_EAGER=true in .env to run tasks synchronously for debugging