{% extends "base.html" %}

{% block title %}Live Attendance - {{ session.class_.class_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Animation Styles */
    .counter-bump {
        animation: bump 0.6s ease;
    }
    
    @keyframes bump {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); color: #28a745; }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
        animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Recognition Status Indicator */
    .recognition-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .recognition-status.active {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        animation: pulse 2s infinite;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    
    .recognition-status.inactive {
        background: #6c757d;
        color: white;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.85; transform: scale(1.05); }
    }
    
    /* Student Item Styles */
    .student-item {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .student-item.status-present {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    
    .student-item.status-late {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.05);
    }
    
    .student-item.status-absent {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.03);
    }
    
    .student-item:hover {
        background: rgba(0, 123, 255, 0.05);
        transform: translateX(5px);
    }
    
    /* Recent Recognition Item */
    .recognition-item {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }
    
    .recognition-item.new {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
        animation: highlight 2s ease;
    }
    
    @keyframes highlight {
        0% { background: rgba(40, 167, 69, 0.3); }
        100% { background: transparent; }
    }
    
    /* Timeline Event */
    .timeline-event {
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background 0.3s;
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-event::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 20px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
    }
    
    .timeline-event:hover {
        background: #f8f9fa;
    }
    
    /* Progress Bar Enhancement */
    .progress {
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        border-radius: 10px;
    }
    
    .progress-bar {
        transition: width 0.5s ease;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Stat Card */
    .stat-card {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .stat-card p {
        margin: 5px 0 0;
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Camera Container */
    .camera-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #camera-canvas {
        display: block;
        width: 100%;
        height: auto;
        max-height: 600px;
    }
    
    /* Camera Status Badge */
    .camera-status-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }
    
    /* Face Detection Overlay */
    .face-box {
        position: absolute;
        border: 3px solid #28a745;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        pointer-events: none;
        animation: fadeIn 0.3s ease;
    }
    
    .face-label {
        position: absolute;
        bottom: -30px;
        left: 0;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }
    
    /* Toast Container */
    #toast-container {
        z-index: 11000;
    }
    
    /* Loading Spinner */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }
    
    /* Empty State */
    .empty-state {
        padding: 40px 20px;
        text-align: center;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        opacity: 0.5;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Hidden Data -->
    <input type="hidden" id="session-id" value="{{ session.session_id }}">
    <input type="hidden" id="user-id" value="{{ current_user.instructor_id }}">
    <input type="hidden" id="class-id" value="{{ session.class_id }}">
    
    <!-- Toast Container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3"></div>
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1">
                <i class="bi bi-camera-video-fill text-primary"></i> 
                Live Attendance Capture
            </h2>
            <p class="text-muted mb-0">
                <strong>{{ session.class_.class_name }}</strong> - {{ session.class_.course.course_name }}
            </p>
            <small class="text-muted">
                <i class="bi bi-calendar3"></i> {{ session.date|format_date }} |
                <i class="bi bi-clock"></i> {{ session.start_time|format_time }} - {{ session.end_time|format_time }} |
                <i class="bi bi-hourglass-split"></i> <span id="session-duration">0 minutes</span>
            </small>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <button id="sync-btn" class="btn btn-outline-primary" title="Sync Data">
                    <i class="bi bi-arrow-clockwise"></i> Sync
                </button>
                <button id="end-session-btn" class="btn btn-danger">
                    <i class="bi bi-stop-circle-fill"></i> End Session
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Camera Feed & Stats -->
        <div class="col-lg-8 mb-4">
            <!-- Camera Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-camera-video"></i> Camera Feed
                        </h5>
                        <div class="d-flex gap-2 align-items-center">
                            <span id="recognition-status" class="recognition-status inactive">
                                <i class="bi bi-circle-fill"></i> Recognition Stopped
                            </span>
                            <span class="badge bg-light text-dark" id="fps-counter">0 FPS</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0 position-relative camera-container">
                    <!-- Camera Canvas -->
                    <canvas id="camera-canvas" width="640" height="480"></canvas>
                    
                    <!-- Face Detection Overlay -->
                    <div id="recognition-overlay" class="position-absolute top-0 start-0 w-100 h-100" 
                         style="pointer-events: none;"></div>
                    
                    <!-- Camera Status Badge -->
                    <div class="camera-status-badge">
                        <span class="badge bg-dark" id="camera-status">
                            <i class="bi bi-circle-fill text-secondary"></i> Ready
                        </span>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="position-absolute bottom-0 start-0 w-100 p-3" 
                         style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                        <div class="d-flex justify-content-center gap-2">
                            <button id="start-camera-btn" class="btn btn-success btn-lg">
                                <i class="bi bi-play-fill"></i> Start Camera
                            </button>
                            <button id="stop-camera-btn" class="btn btn-danger btn-lg" style="display: none;">
                                <i class="bi bi-stop-fill"></i> Stop Camera
                            </button>
                            <button id="switch-camera-btn" class="btn btn-secondary">
                                <i class="bi bi-arrow-repeat"></i> Switch
                            </button>
                            <button id="snapshot-btn" class="btn btn-info">
                                <i class="bi bi-camera"></i> Snapshot
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Footer -->
                <div class="card-footer bg-light">
                    <div class="row text-center g-0">
                        <div class="col-3">
                            <div class="stat-card bg-white border-end">
                                <h3 id="recognized-count" class="text-primary">0</h3>
                                <p class="text-muted mb-0">Recognized</p>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-card bg-white border-end">
                                <h3 id="present-count" class="text-success">{{ stats.present }}</h3>
                                <p class="text-muted mb-0">Present</p>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-card bg-white border-end">
                                <h3 id="late-count" class="text-warning">{{ stats.late }}</h3>
                                <p class="text-muted mb-0">Late</p>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-card bg-white">
                                <h3 id="absent-count" class="text-danger">{{ stats.absent }}</h3>
                                <p class="text-muted mb-0">Absent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Recognitions Feed -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history text-primary"></i> Recent Recognitions
                    </h6>
                    <button id="clear-feed-btn" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="recent-recognitions-feed" class="list-group list-group-flush" 
                         style="max-height: 250px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0">No recognitions yet. Start the camera to begin.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Timeline -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-list-check text-primary"></i> Attendance Timeline
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div id="attendance-timeline" style="max-height: 300px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="bi bi-journal-x"></i>
                            <p class="mb-0">Timeline will appear here as students are marked.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Student List & Progress -->
        <div class="col-lg-4">
            <!-- Progress Card -->
            <div class="card shadow-sm mb-3 sticky-top" style="top: 80px;">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart-fill text-primary"></i> Attendance Progress
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="progress mb-3" style="height: 35px;">
                        <div id="attendance-progress-bar" 
                             class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ (stats.present + stats.late) / stats.total_expected * 100 if stats.total_expected > 0 else 0 }}%"
                             aria-valuenow="{{ stats.present + stats.late }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ stats.total_expected }}">
                            <strong id="progress-text">
                                {{ stats.present + stats.late }}/{{ stats.total_expected }}
                            </strong>
                        </div>
                    </div>
                    
                    <!-- Attendance Rate -->
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Attendance Rate:</span>
                        <span class="fs-4 fw-bold text-success" id="attendance-percentage">
                            {{ stats.attendance_rate }}%
                        </span>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="row mt-3 text-center">
                        <div class="col-4">
                            <small class="text-muted d-block">Total</small>
                            <strong id="total-count">{{ stats.total_expected }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Marked</small>
                            <strong id="marked-count">{{ stats.present + stats.late }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Pending</small>
                            <strong id="pending-count">{{ stats.absent }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student List Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-people-fill text-primary"></i> 
                            Expected Students (<span id="student-count">{{ stats.total_expected }}</span>)
                        </h6>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="student-search" class="form-control" 
                               placeholder="Search students...">
                    </div>
                    
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <input type="radio" class="btn-check" name="filter" id="filter-all" 
                               data-filter="all" checked>
                        <label class="btn btn-outline-secondary" for="filter-all">
                            All ({{ stats.total_expected }})
                        </label>
                        
                        <input type="radio" class="btn-check" name="filter" id="filter-present" 
                               data-filter="Present">
                        <label class="btn btn-outline-success" for="filter-present">
                            Present ({{ stats.present }})
                        </label>
                        
                        <input type="radio" class="btn-check" name="filter" id="filter-absent" 
                               data-filter="Absent">
                        <label class="btn btn-outline-danger" for="filter-absent">
                            Absent ({{ stats.absent }})
                        </label>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div id="student-list" class="list-group list-group-flush" 
                         style="max-height: 500px; overflow-y: auto;">
                        {% for student in expected_students %}
                        <div class="list-group-item student-item" 
                             data-student-id="{{ student.student_id }}"
                             data-status="{{ student.attendance_status }}"
                             data-name="{{ student.name|lower }}">
                            <div class="d-flex align-items-center">
                                <!-- Avatar -->
                                <img src="{{ student.image_path or '/static/images/default-avatar.png' }}" 
                                     alt="{{ student.name }}"
                                     class="rounded-circle me-3"
                                     style="width: 45px; height: 45px; object-fit: cover;"
                                     onerror="this.src='/static/images/default-avatar.png'">
                                
                                <!-- Student Info -->
                                <div class="flex-grow-1">
                                    <div class="fw-bold student-name">{{ student.name }}</div>
                                    <small class="text-muted student-id">{{ student.student_id }}</small>
                                    
                                    {% if student.confidence_score %}
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <i class="bi bi-shield-check"></i> 
                                            {{ (student.confidence_score * 100)|round(1) }}% | 
                                            <i class="bi bi-clock"></i> 
                                            {{ student.attendance_time|format_datetime('%H:%M:%S') }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Status & Actions -->
                                <div class="text-end">
                                    <span class="badge status-badge mb-2
                                        {% if student.attendance_status == 'Present' %}bg-success
                                        {% elif student.attendance_status == 'Late' %}bg-warning text-dark
                                        {% elif student.attendance_status == 'Excused' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {{ student.attendance_status }}
                                    </span>
                                    
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-success mark-btn" 
                                                data-status="Present" 
                                                title="Mark Present">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button class="btn btn-outline-warning mark-btn" 
                                                data-status="Late" 
                                                title="Mark Late">
                                            <i class="bi bi-clock"></i>
                                        </button>
                                        <button class="btn btn-outline-danger mark-btn" 
                                                data-status="Absent" 
                                                title="Mark Absent">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Card Footer Actions -->
                <div class="card-footer bg-white">
                    <div class="d-grid gap-2">
                        <button id="mark-all-present-btn" class="btn btn-success">
                            <i class="bi bi-check-all"></i> Mark All Present
                        </button>
                        <button id="mark-unmarked-absent-btn" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Mark Unmarked as Absent
                        </button>
                        <button id="export-csv-btn" class="btn btn-outline-primary">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div class="modal fade" id="endSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-stop-circle"></i> End Session
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="end-session-form" method="POST" 
                  action="{{ url_for('lecturer_attendance.end_session', session_id=session.session_id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Warning:</strong> This will finalize the session. 
                        Students not yet marked will be automatically marked as absent.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Session Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="3" 
                                  placeholder="Add any notes about this session (e.g., technical issues, special circumstances)..."></textarea>
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Final Statistics</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fs-3 text-success fw-bold" id="final-present">{{ stats.present }}</div>
                                    <small class="text-muted">Present</small>
                                </div>
                                <div class="col-4">
                                    <div class="fs-3 text-warning fw-bold" id="final-late">{{ stats.late }}</div>
                                    <small class="text-muted">Late</small>
                                </div>
                                <div class="col-4">
                                    <div class="fs-3 text-danger fw-bold" id="final-absent">{{ stats.absent }}</div>
                                    <small class="text-muted">Absent</small>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <strong>Attendance Rate: </strong>
                                <span class="fs-5 text-success" id="final-rate">{{ stats.attendance_rate }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-check-circle"></i> End Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="noteStudentId">
                <input type="hidden" id="noteAttendanceId">
                <div class="mb-3">
                    <label class="form-label">Student:</label>
                    <div id="noteStudentName" class="fw-bold"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Note:</label>
                    <textarea id="noteText" class="form-control" rows="4" 
                              placeholder="Enter note about this attendance record..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">
                    <i class="bi bi-save"></i> Save Note
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Custom Scripts -->
<script src="{{ url_for('static', filename='js/camera_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/attendance_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/progress_tracker.js') }}"></script>

<script>
// Global variables
const SESSION_ID = {{ session.session_id }};
const USER_ID = '{{ current_user.instructor_id }}';
const CLASS_ID = '{{ session.class_id }}';

let cameraHandler;
let attendanceHandler;
let progressTracker;
let recognitionActive = false;
let sessionStartTime = new Date();

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    initializeComponents();
    initializeEventListeners();
    startSessionTimer();
});

// ========== Initialization ==========

function initializeComponents() {
    // Initialize camera handler
    cameraHandler = new CameraHandler('camera-canvas', {
        width: 640,
        height: 480,
        fps: 10
    });
    
    // Initialize real-time attendance handler (from attendance_realtime.js)
    if (typeof AttendanceRealtimeHandler !== 'undefined') {
        attendanceHandler = new AttendanceRealtimeHandler(SESSION_ID, USER_ID);
    }
    
    // Initialize progress tracker (from progress_tracker.js)
    if (typeof ProgressTracker !== 'undefined') {
        progressTracker = new ProgressTracker(SESSION_ID);
    }
}

function initializeEventListeners() {
    // Camera controls
    document.getElementById('start-camera-btn').addEventListener('click', startCamera);
    document.getElementById('stop-camera-btn').addEventListener('click', stopCamera);
    document.getElementById('switch-camera-btn').addEventListener('click', switchCamera);
    document.getElementById('snapshot-btn').addEventListener('click', takeSnapshot);
    
    // Student search
    document.getElementById('student-search').addEventListener('input', filterStudents);
    
    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('change', filterByStatus);
    });
    
    // Manual marking
    document.querySelectorAll('.mark-btn').forEach(btn => {
        btn.addEventListener('click', handleManualMark);
    });
    
    // Bulk actions
    document.getElementById('mark-all-present-btn').addEventListener('click', markAllPresent);
    document.getElementById('mark-unmarked-absent-btn').addEventListener('click', markUnmarkedAbsent);
    
    // Other actions
    document.getElementById('sync-btn').addEventListener('click', syncData);
    document.getElementById('end-session-btn').addEventListener('click', showEndSessionModal);
    document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
    // ========== CONTINUATION OF live_attendance.html <script> section ==========

    // Clear recognitions feed
    document.getElementById('clear-feed-btn').addEventListener('click', clearRecognitionsFeed);
    
    // End session
    document.getElementById('end-session-form').addEventListener('submit', handleEndSession);
}

// ========== Camera Functions ==========

async function startCamera() {
    try {
        const startBtn = document.getElementById('start-camera-btn');
        const stopBtn = document.getElementById('stop-camera-btn');
        
        startBtn.disabled = true;
        updateCameraStatus('Initializing...', 'warning');
        
        await cameraHandler.start();
        
        // Toggle buttons
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        
        // Start recognition
        startRecognition();
        
        updateCameraStatus('Active', 'success');
        showToast('Camera started successfully', 'success');
        
    } catch (error) {
        console.error('Failed to start camera:', error);
        showToast('Failed to start camera: ' + error.message, 'error');
        updateCameraStatus('Error', 'danger');
        document.getElementById('start-camera-btn').disabled = false;
    }
}

function stopCamera() {
    try {
        cameraHandler.stop();
        stopRecognition();
        
        // Toggle buttons
        document.getElementById('start-camera-btn').style.display = 'inline-block';
        document.getElementById('stop-camera-btn').style.display = 'none';
        document.getElementById('start-camera-btn').disabled = false;
        
        updateCameraStatus('Stopped', 'secondary');
        showToast('Camera stopped', 'info');
        
    } catch (error) {
        console.error('Failed to stop camera:', error);
        showToast('Failed to stop camera: ' + error.message, 'error');
    }
}

async function switchCamera() {
    try {
        await cameraHandler.switchCamera();
        showToast('Camera switched', 'success');
    } catch (error) {
        console.error('Failed to switch camera:', error);
        showToast('Failed to switch camera: ' + error.message, 'error');
    }
}

function takeSnapshot() {
    try {
        const dataUrl = cameraHandler.captureFrame();
        
        // Create download link
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `snapshot_${Date.now()}.png`;
        link.click();
        
        showToast('Snapshot saved', 'success');
        
    } catch (error) {
        console.error('Failed to take snapshot:', error);
        showToast('Failed to take snapshot: ' + error.message, 'error');
    }
}

function updateCameraStatus(status, type) {
    const statusBadge = document.getElementById('camera-status');
    const iconClass = type === 'success' ? 'text-success' : 
                     type === 'warning' ? 'text-warning' : 
                     type === 'danger' ? 'text-danger' : 'text-secondary';
    
    statusBadge.innerHTML = `<i class="bi bi-circle-fill ${iconClass}"></i> ${status}`;
}

// ========== Recognition Functions ==========

function startRecognition() {
    if (recognitionActive) return;
    
    recognitionActive = true;
    const statusBadge = document.getElementById('recognition-status');
    statusBadge.classList.remove('inactive');
    statusBadge.classList.add('active');
    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Recognition Active';
    
    // Start sending frames for recognition
    if (attendanceHandler) {
        attendanceHandler.startRecognition();
    }
    
    showToast('Face recognition started', 'success');
}

function stopRecognition() {
    if (!recognitionActive) return;
    
    recognitionActive = false;
    const statusBadge = document.getElementById('recognition-status');
    statusBadge.classList.remove('active');
    statusBadge.classList.add('inactive');
    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Recognition Stopped';
    
    // Stop sending frames
    if (attendanceHandler) {
        attendanceHandler.stopRecognition();
    }
    
    showToast('Face recognition stopped', 'info');
}

// ========== Student List Functions ==========

function filterStudents() {
    const searchTerm = document.getElementById('student-search').value.toLowerCase();
    const students = document.querySelectorAll('.student-item');
    let visibleCount = 0;
    
    students.forEach(student => {
        const name = student.dataset.name || '';
        const studentId = student.querySelector('.student-id')?.textContent.toLowerCase() || '';
        
        const matches = name.includes(searchTerm) || studentId.includes(searchTerm);
        
        if (matches) {
            student.style.display = '';
            visibleCount++;
        } else {
            student.style.display = 'none';
        }
    });
    
    // Update count
    document.getElementById('student-count').textContent = visibleCount;
}

function filterByStatus(event) {
    const filter = event.target.dataset.filter;
    const students = document.querySelectorAll('.student-item');
    let visibleCount = 0;
    
    students.forEach(student => {
        const status = student.dataset.status;
        
        if (filter === 'all' || status === filter) {
            student.style.display = '';
            visibleCount++;
        } else {
            student.style.display = 'none';
        }
    });
    
    document.getElementById('student-count').textContent = visibleCount;
}

// ========== Manual Marking Functions ==========

async function handleManualMark(event) {
    const button = event.currentTarget;
    const studentItem = button.closest('.student-item');
    const studentId = studentItem.dataset.studentId;
    const status = button.dataset.status;
    
    try {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        const response = await fetch(`/lecturer/attendance/mark/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                status: status,
                method: 'manual'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateStudentStatus(studentId, status);
            showToast(`${data.student_name} marked as ${status}`, 'success');
            
            // Add to timeline
            addTimelineEvent(data.student_name, status, 'manual');
        } else {
            showToast(data.message || 'Failed to mark attendance', 'error');
        }
        
    } catch (error) {
        console.error('Error marking attendance:', error);
        showToast('Failed to mark attendance', 'error');
    } finally {
        // Restore button
        const iconClass = status === 'Present' ? 'check-lg' : 
                         status === 'Late' ? 'clock' : 'x-lg';
        button.innerHTML = `<i class="bi bi-${iconClass}"></i>`;
        button.disabled = false;
    }
}

function updateStudentStatus(studentId, status) {
    const studentItem = document.querySelector(`[data-student-id="${studentId}"]`);
    if (!studentItem) return;
    
    // Update dataset
    studentItem.dataset.status = status;
    
    // Update badge
    const badge = studentItem.querySelector('.status-badge');
    badge.className = 'badge status-badge mb-2';
    
    if (status === 'Present') {
        badge.classList.add('bg-success');
        studentItem.classList.add('status-present');
    } else if (status === 'Late') {
        badge.classList.add('bg-warning', 'text-dark');
        studentItem.classList.add('status-late');
    } else if (status === 'Absent') {
        badge.classList.add('bg-secondary');
        studentItem.classList.add('status-absent');
    }
    
    badge.textContent = status;
    
    // Add animation
    studentItem.classList.add('fade-in');
    setTimeout(() => studentItem.classList.remove('fade-in'), 500);
}

// ========== Bulk Actions ==========

async function markAllPresent() {
    if (!confirm('Are you sure you want to mark all students as Present?')) {
        return;
    }
    
    try {
        const response = await fetch(`/lecturer/attendance/bulk-mark/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'Present',
                method: 'bulk_manual'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update all student statuses
            document.querySelectorAll('.student-item').forEach(item => {
                updateStudentStatus(item.dataset.studentId, 'Present');
            });
            
            showToast(`${data.count} students marked as Present`, 'success');
            
            // Refresh stats
            if (progressTracker) {
                progressTracker.refresh();
            }
        } else {
            showToast(data.message || 'Failed to mark all present', 'error');
        }
        
    } catch (error) {
        console.error('Error marking all present:', error);
        showToast('Failed to mark all present', 'error');
    }
}

async function markUnmarkedAbsent() {
    if (!confirm('Mark all unmarked students as Absent?')) {
        return;
    }
    
    try {
        const response = await fetch(`/lecturer/attendance/mark-unmarked-absent/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update unmarked students
            document.querySelectorAll('.student-item[data-status="Absent"]').forEach(item => {
                updateStudentStatus(item.dataset.studentId, 'Absent');
            });
            
            showToast(`${data.count} students marked as Absent`, 'info');
            
            if (progressTracker) {
                progressTracker.refresh();
            }
        } else {
            showToast(data.message || 'Failed to mark unmarked absent', 'error');
        }
        
    } catch (error) {
        console.error('Error marking unmarked absent:', error);
        showToast('Failed to mark unmarked absent', 'error');
    }
}

// ========== Timeline Functions ==========

function addTimelineEvent(studentName, status, method) {
    const timeline = document.getElementById('attendance-timeline');
    const emptyState = timeline.querySelector('.empty-state');
    
    // Remove empty state if exists
    if (emptyState) {
        emptyState.remove();
    }
    
    const event = document.createElement('div');
    event.className = 'timeline-event slide-in';
    
    const time = new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const methodBadge = method === 'face_recognition' 
        ? '<span class="badge bg-primary">Face Recognition</span>'
        : '<span class="badge bg-secondary">Manual</span>';
    
    const statusColor = status === 'Present' ? 'success' : 
                       status === 'Late' ? 'warning' : 'secondary';
    
    event.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>${studentName}</strong>
                <span class="badge bg-${statusColor} ms-2">${status}</span>
                ${methodBadge}
            </div>
            <small class="text-muted">${time}</small>
        </div>
    `;
    
    // Insert at top
    timeline.insertBefore(event, timeline.firstChild);
    
    // Limit to 50 events
    const events = timeline.querySelectorAll('.timeline-event');
    if (events.length > 50) {
        events[events.length - 1].remove();
    }
}

function clearRecognitionsFeed() {
    const feed = document.getElementById('recent-recognitions-feed');
    feed.innerHTML = `
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p class="mb-0">No recognitions yet. Start the camera to begin.</p>
        </div>
    `;
}

// ========== Sync & Export Functions ==========

async function syncData() {
    const syncBtn = document.getElementById('sync-btn');
    const originalContent = syncBtn.innerHTML;
    
    try {
        syncBtn.disabled = true;
        syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Syncing...';
        
        const response = await fetch(`/lecturer/attendance/sync/${SESSION_ID}`);
        const data = await response.json();
        
        if (data.success) {
            showToast('Data synchronized successfully', 'success');
            
            // Refresh progress tracker
            if (progressTracker) {
                progressTracker.refresh();
            }
            
            // Update stats
            updateStats(data.stats);
        } else {
            showToast('Failed to sync data', 'error');
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        showToast('Failed to sync data', 'error');
    } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = originalContent;
    }
}

async function exportCSV() {
    try {
        const response = await fetch(`/lecturer/attendance/export/${SESSION_ID}?format=csv`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_session_${SESSION_ID}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('CSV exported successfully', 'success');
        } else {
            showToast('Failed to export CSV', 'error');
        }
        
    } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export CSV', 'error');
    }
}

// ========== Session Management ==========

function showEndSessionModal() {
    // Update final stats in modal
    document.getElementById('final-present').textContent = 
        document.getElementById('present-count').textContent;
    document.getElementById('final-late').textContent = 
        document.getElementById('late-count').textContent;
    document.getElementById('final-absent').textContent = 
        document.getElementById('absent-count').textContent;
    document.getElementById('final-rate').textContent = 
        document.getElementById('attendance-percentage').textContent + '%';
    
    const modal = new bootstrap.Modal(document.getElementById('endSessionModal'));
    modal.show();
}

async function handleEndSession(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ending...';
        
        // Stop camera and recognition first
        if (recognitionActive) {
            stopRecognition();
        }
        if (cameraHandler && cameraHandler.isActive()) {
            stopCamera();
        }
        
        // Submit form
        form.submit();
        
    } catch (error) {
        console.error('Error ending session:', error);
        showToast('Failed to end session', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function startSessionTimer() {
    updateSessionDuration();
    setInterval(updateSessionDuration, 60000); // Update every minute
}

function updateSessionDuration() {
    const now = new Date();
    const diff = now - sessionStartTime;
    const minutes = Math.floor(diff / 60000);
    
    document.getElementById('session-duration').textContent = `${minutes} minutes`;
}

// ========== Stats Update Functions ==========

function updateStats(stats) {
    // Update counters
    document.getElementById('present-count').textContent = stats.present;
    document.getElementById('late-count').textContent = stats.late;
    document.getElementById('absent-count').textContent = stats.absent;
    document.getElementById('total-count').textContent = stats.total_expected;
    
    const marked = stats.present + stats.late;
    document.getElementById('marked-count').textContent = marked;
    document.getElementById('pending-count').textContent = stats.absent;
    
    // Update progress bar
    const percentage = stats.total_expected > 0 
        ? Math.round((marked / stats.total_expected) * 100) 
        : 0;
    
    const progressBar = document.getElementById('attendance-progress-bar');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', marked);
    
    document.getElementById('progress-text').textContent = `${marked}/${stats.total_expected}`;
    document.getElementById('attendance-percentage').textContent = stats.attendance_rate;
    
    // Animate counters
    document.getElementById('present-count').classList.add('counter-bump');
    setTimeout(() => {
        document.getElementById('present-count').classList.remove('counter-bump');
    }, 600);
}

// ========== Toast Notifications ==========

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const bgClass = type === 'success' ? 'bg-success' :
                   type === 'error' ? 'bg-danger' :
                   type === 'warning' ? 'bg-warning' : 'bg-info';
    
    const icon = type === 'success' ? 'check-circle-fill' :
                type === 'error' ? 'exclamation-triangle-fill' :
                type === 'warning' ? 'exclamation-circle-fill' : 'info-circle-fill';
    
    toast.className = `toast align-items-center text-white ${bgClass} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${icon} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// ========== Event Listeners for Real-time Updates ==========

// Listen for attendance updates from SocketIO
if (typeof io !== 'undefined' && attendanceHandler) {
    attendanceHandler.on('attendance_marked', (data) => {
        updateStudentStatus(data.student_id, data.status);
        addTimelineEvent(data.student_name, data.status, data.method);
        
        // Add to recognition feed
        addRecognitionToFeed(data);
        
        // Update stats
        updateStats(data.stats);
        
        // Show notification
        showToast(`${data.student_name} marked as ${data.status}`, 'success');
    });
    
    attendanceHandler.on('student_recognized', (data) => {
        // Highlight student in list
        const studentItem = document.querySelector(`[data-student-id="${data.student_id}"]`);
        if (studentItem) {
            studentItem.classList.add('fade-in');
            setTimeout(() => studentItem.classList.remove('fade-in'), 500);
        }
        
        // Update recognized counter
        const recognizedCount = document.getElementById('recognized-count');
        recognizedCount.textContent = parseInt(recognizedCount.textContent) + 1;
        recognizedCount.classList.add('counter-bump');
        setTimeout(() => recognizedCount.classList.remove('counter-bump'), 600);
    });
    
    attendanceHandler.on('unknown_face', (data) => {
        showToast('Unknown face detected', 'warning');
    });
}

function addRecognitionToFeed(data) {
    const feed = document.getElementById('recent-recognitions-feed');
    const emptyState = feed.querySelector('.empty-state');
    
    if (emptyState) {
        emptyState.remove();
    }
    
    const item = document.createElement('div');
    item.className = 'list-group-item recognition-item new slide-in';
    
    const time = new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    
    const confidence = data.confidence_score 
        ? Math.round(data.confidence_score * 100) 
        : 0;
    
    item.innerHTML = `
        <div class="d-flex align-items-center">
            <img src="${data.image_path || '/static/images/default-avatar.png'}" 
                 alt="${data.student_name}"
                 class="rounded-circle me-3"
                 style="width: 40px; height: 40px; object-fit: cover;"
                 onerror="this.src='/static/images/default-avatar.png'">
            <div class="flex-grow-1">
                <strong>${data.student_name}</strong>
                <div class="small text-muted">
                    <i class="bi bi-shield-check"></i> ${confidence}% confidence
                </div>
            </div>
            <div class="text-end">
                <span class="badge bg-${data.status === 'Present' ? 'success' : 'warning'}">${data.status}</span>
                <div class="small text-muted">${time}</div>
            </div>
        </div>
    `;
    
    feed.insertBefore(item, feed.firstChild);
    
    // Remove 'new' class after animation
    setTimeout(() => {
        item.classList.remove('new');
    }, 2000);
    
    // Limit to 20 items
    const items = feed.querySelectorAll('.recognition-item');
    if (items.length > 20) {
        items[items.length - 1].remove();
    }
}

// ========== Keyboard Shortcuts ==========

document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Space: Start/Stop camera
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
        e.preventDefault();
        const startBtn = document.getElementById('start-camera-btn');
        const stopBtn = document.getElementById('stop-camera-btn');
        
        if (startBtn.style.display !== 'none') {
            startCamera();
        } else {
            stopCamera();
        }
    }
    
    // Ctrl/Cmd + S: Sync data
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        syncData();
    }
    
    // Ctrl/Cmd + E: Export CSV
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportCSV();
    }
    
    // Esc: Stop recognition
    if (e.key === 'Escape' && recognitionActive) {
        stopRecognition();
    }
});

// ========== Cleanup on Page Unload ==========

window.addEventListener('beforeunload', (e) => {
    if (recognitionActive) {
        e.preventDefault();
        e.returnValue = 'Attendance session is still active. Are you sure you want to leave?';
        return e.returnValue;
    }
});

window.addEventListener('unload', () => {
    if (cameraHandler) {
        cameraHandler.stop();
    }
    if (attendanceHandler) {
        attendanceHandler.disconnect();
    }
});

// ========== Auto-refresh Progress (Optional) ==========

// Auto-refresh stats every 30 seconds if enabled
const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
let autoRefreshTimer = null;

function enableAutoRefresh() {
    if (autoRefreshTimer) return;
    
    autoRefreshTimer = setInterval(async () => {
        if (recognitionActive) {
            await syncData();
        }
    }, AUTO_REFRESH_INTERVAL);
}

function disableAutoRefresh() {
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
}

// Enable auto-refresh when camera is active
document.getElementById('start-camera-btn').addEventListener('click', () => {
    setTimeout(enableAutoRefresh, 1000);
});

document.getElementById('stop-camera-btn').addEventListener('click', () => {
    disableAutoRefresh();
});

// ========== Initialize Performance Monitoring ==========

let frameCount = 0;
let lastFpsUpdate = Date.now();

function updateFPS() {
    frameCount++;
    const now = Date.now();
    const elapsed = now - lastFpsUpdate;
    
    if (elapsed >= 1000) {
        const fps = Math.round((frameCount * 1000) / elapsed);
        document.getElementById('fps-counter').textContent = `${fps} FPS`;
        frameCount = 0;
        lastFpsUpdate = now;
    }
}

// Call updateFPS on each frame if camera is active
if (cameraHandler) {
    cameraHandler.onFrame = updateFPS;
}

</script>
{% endblock %}
